= Comment provoquer un D√©sastre ?
:description: Syst√®me d'effets visuels et sonores dynamiques pour Musique Approximative

:toclevels: 2

== Vue d'ensemble

Les **d√©sastres** sont un syst√®me d'effets visuels et sonores qui se d√©clenchent automatiquement sur le site selon des r√®gles d√©finies. Ils cr√©ent des exp√©riences interactives surprenantes et ludiques pour les visiteurs.

Le syst√®me repose sur trois composants principaux :

* **R√®gles** : Conditions de d√©clenchement bas√©es sur le contenu (titre, artiste, etc.)
* **Recettes** : Configuration des effets √† appliquer
* **D√©sastres** : Impl√©mentations JavaScript/CSS des effets visuels

== Architecture

=== Structure des fichiers

[source,text]
----
src/
‚îú‚îÄ‚îÄ apps/frontend/config/desastres/
‚îÇ   ‚îú‚îÄ‚îÄ desastres.yml              # Configuration principale avec imports
‚îÇ   ‚îú‚îÄ‚îÄ regles/                    # R√®gles de d√©clenchement
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ colors.yml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ misc.yml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ recettes/                  # Configuration des effets
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mangelettres.yml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tts.yml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ splitouine.yml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ schemas/                   # Sch√©mas de validation JSON
‚îÇ       ‚îú‚îÄ‚îÄ regles.schema.json
‚îÇ       ‚îú‚îÄ‚îÄ recettes.schema.json
‚îÇ       ‚îî‚îÄ‚îÄ desastres-main.schema.json
‚îî‚îÄ‚îÄ web/desastres/                 # Impl√©mentations des d√©sastres
    ‚îú‚îÄ‚îÄ mangelettres/
    ‚îú‚îÄ‚îÄ splitouine/
    ‚îú‚îÄ‚îÄ fish/
    ‚îú‚îÄ‚îÄ light/
    ‚îú‚îÄ‚îÄ tts/
    ‚îî‚îÄ‚îÄ ...
----

=== Flux de fonctionnement

[mermaid]
----
graph TD
    A[Page charg√©e] --> B{√âvaluation des r√®gles}
    B -->|Condition remplie| C{Test de probabilit√©}
    B -->|Condition non remplie| Z[Aucun d√©sastre]
    C -->|Succ√®s| D[Chargement des recettes]
    C -->|√âchec| Z
    D --> E[Chargement des scripts JS]
    E --> F[Application du d√©sastre]
    F --> G[Effet visuel/sonore actif]
----

== Types de d√©sastres

=== D√©sastres visuels

==== mangelettres
Fait dispara√Ætre progressivement certaines lettres du texte.

**Technologie** : GSAP SplitText

**Options** :

* `rate` : Taux de suppression (0.0 √† 1.0)
* `letters` : Lettres √† supprimer (ex: "aeiou")
* `selector` : S√©lecteur CSS de l'√©l√©ment cible

**Exemple** :
[source,yaml]
----
recettes:
  mange_voyelles:
    enabled: true
    desastre: mangelettres
    options:
      rate: 0.5
      letters: "aeiou"
      selector: "section.content"
----

==== splitouine
Animation de texte avec effets de division et de mouvement.

**Technologie** : GSAP SplitText

**Caract√©ristiques** :

* Division du texte en caract√®res individuels
* Animations fluides et personnalisables
* Effets de rotation, translation, opacit√©

==== fish (https://www.musiqueapproximative.net/post/the-toilet-fish-and-shit[d√©mo])
Affiche un poisson anim√© qui suit le curseur de la souris.

**Technologie** : Lottie

**Comportement** :

* Suivi du curseur avec d√©calage vertical
* Animation Lottie en boucle
* Superposition en z-index √©lev√©

==== light (https://www.musiqueapproximative.net/post/couronne-de-merde-friday-night-there-s-no-light[d√©mo])
Cr√©e des rayons lumineux traversant la page.

**Technologie** : CSS + Web Animations API

**Effet** :

* Trois rayons lumineux anim√©s
* D√©placement horizontal de gauche √† droite
* Rotation √† 45¬∞

==== musique (https://www.musiqueapproximative.net/post/jacques-chirac-musique-officielle-de-sa-campagne-de-1981[d√©mo])
Retire les lettres "M" et les fait d√©filer sur une port√©e musicale SVG.

**Technologie** : anime.js + SVG

**Particularit√©s** :

* Extraction des lettres "M" et "m"
* G√©n√©ration dynamique d'une port√©e SVG
* Animation sinuso√Ødale des lettres

==== noir / bleu
Change la couleur de fond de la page.

**Impl√©mentation** : CSS simple

**Options** :

* `noir` : Fond noir
* `bleu` : Fond bleu

=== D√©sastres sonores

==== tts (Text-to-Speech) (https://www.musiqueapproximative.net/post/eat-rabbit-tts-rapper[d√©mo])
Synth√®se vocale du contenu de la page.

**Technologie** : Web Speech API

**Options configurables** :

* `rate` : Vitesse de lecture (0.1 √† 10, ou plage [min, max])
* `pitch` : Hauteur de la voix (0 √† 2, ou plage [min, max])
* `volume` : Volume (0 √† 1, ou plage [min, max])
* `lang` : Code langue (ex: "fr-FR", "en-US")
* `voices` : Liste de noms de voix pr√©f√©r√©es
* `texts` : Textes √† lire (si non fourni, lit le contenu de la page)

**Exemple** :
[source,yaml]
----
recettes:
  tts_robot:
    enabled: true
    desastre: tts
    options:
      rate: [0.8, 1.2]    # Vitesse al√©atoire entre 0.8 et 1.2
      pitch: [0.5, 0.7]   # Voix grave
      volume: 0.8
      lang: "fr-FR"
      voices: ["Google fran√ßais", "Microsoft Hortense"]
----

=== D√©sastres interactifs

==== redirect
Redirige vers une URL externe.

**Options** :

* `url` : URL de destination

**Exemple** :
[source,yaml]
----
recettes:
  redirect_kraftwerk:
    enabled: true
    desastre: redirect
    options:
      url: "https://www.kraftwerk.com"
----

==== mamie
Affiche des images al√©atoires en superposition.

**Options** :

* `imageFolder` : Dossier contenant les images
* `imageBaseName` : Pr√©fixe des noms de fichiers
* `imageExtension` : Extension des fichiers
* `imageCount` : Nombre d'images disponibles

== Configuration

=== D√©finir une r√®gle

Les r√®gles d√©terminent **quand** un d√©sastre se d√©clenche.

**Structure** :
[source,yaml]
----
# yaml-language-server: $schema=../schemas/regles.schema.json

regles:
  - query: "query.title ~ /.*bleu.*/i"
    recettes: [bleu]
    probability: 0.7
    trigger: debug_bleu
----

**Propri√©t√©s** :

* `query` (requis) : Expression de condition
** Syntaxe : `query.FIELD ~ /REGEX/FLAGS`
** Champs disponibles : `title`, `artist`, `album`, etc.
* `recettes` (requis) : Liste des recettes √† appliquer
* `probability` : Probabilit√© de d√©clenchement (0.0 √† 1.0, d√©faut: 1.0)
* `trigger` : Param√®tre URL pour forcer le d√©clenchement (ex: `?debug_bleu`)

**Exemples de conditions** :

[source,yaml]
----
# Titre contient "fish" ou "poisson"
query: "query.title ~ /.*(fish|poisson).*/i"

# Artiste exact
query: "query.artist == 'Kraftwerk'"

# Titre commence par "La"
query: "query.title ~ /^La .*/i"
----

=== Cr√©er une recette

Les recettes d√©finissent **comment** le d√©sastre se comporte.

**Structure** :
[source,yaml]
----
# yaml-language-server: $schema=../schemas/recettes.schema.json

recettes:
  nom_recette:
    enabled: true
    desastre: type_desastre
    scripts:
      - "/desastres/shared/gsap.min.js"
      - "/desastres/mangelettres/javascript/mangelettres.js"
    options:
      # Options sp√©cifiques au d√©sastre
      rate: 0.5
      selector: "section.content"
----

**Propri√©t√©s** :

* `enabled` (requis) : Active/d√©sactive la recette
* `desastre` (requis) : Type de d√©sastre (correspond au dossier dans `/desastres/`)
* `scripts` : Scripts JavaScript √† charger
* `options` : Configuration sp√©cifique au d√©sastre

=== Validation avec JSON Schema

Le syst√®me utilise des sch√©mas JSON pour valider la configuration.

**Avantages** :

* ‚úÖ Autocompl√©tion dans VSCode, IntelliJ
* ‚úÖ Validation en temps r√©el
* ‚úÖ Documentation int√©gr√©e
* ‚úÖ Pr√©vention d'erreurs

**Installation dans VSCode** :

. Installer l'extension **YAML** (Red Hat)
. Ajouter la directive `# yaml-language-server` en haut des fichiers
. Profiter de l'autocompl√©tion ! üéâ

**Validation en ligne de commande** :

[source,bash]
----
npm install -g ajv-cli

# Valider un fichier de r√®gles
ajv validate -s schemas/regles.schema.json -d regles/colors.yml

# Valider un fichier de recettes
ajv validate -s schemas/recettes.schema.json -d recettes/tts.yml
----

== D√©veloppement

=== Cr√©er un nouveau d√©sastre

. **Cr√©er le dossier** dans `src/web/desastres/mon-desastre/`
+
[source,bash]
----
mkdir -p src/web/desastres/mon-desastre/javascript
mkdir -p src/web/desastres/mon-desastre/css
----

. **Cr√©er le fichier JavaScript** `javascript/mon-desastre.js`
+
[source,javascript]
----
/**
 * D√©sastre Mon D√©sastre
 */
(function() {
  console.log('üé≠ D√©sastre "mon-desastre" activ√©');
  
  // R√©cup√©rer les options depuis window.desastreOptions
  const options = window.desastreOptions || {};
  
  // Impl√©menter l'effet
  function appliquerDesastre() {
    // Votre code ici
  }
  
  // Initialiser
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', appliquerDesastre);
  } else {
    appliquerDesastre();
  }
})();
----

. **Cr√©er le fichier CSS** (optionnel) `css/mon-desastre.css`

. **Cr√©er la recette** dans `src/apps/frontend/config/desastres/recettes/mon-desastre.yml`
+
[source,yaml]
----
# yaml-language-server: $schema=../schemas/recettes.schema.json

recettes:
  mon_desastre:
    enabled: true
    desastre: mon-desastre
    scripts:
      - "/desastres/mon-desastre/javascript/mon-desastre.js"
    options:
      # Vos options personnalis√©es
      intensity: 0.8
----

. **Cr√©er la r√®gle** dans `src/apps/frontend/config/desastres/regles/mon-desastre.yml`
+
[source,yaml]
----
# yaml-language-server: $schema=../schemas/regles.schema.json

regles:
  - query: "query.title ~ /.*test.*/i"
    recettes: [mon_desastre]
    probability: 1.0
    trigger: debug_mon_desastre
----

. **Importer dans la configuration principale** `desastres.yml`
+
[source,yaml]
----
imports:
  - { resource: regles/mon-desastre.yml }
  - { resource: recettes/mon-desastre.yml }
----

. **Documenter** : Cr√©er `src/web/desastres/mon-desastre/README.adoc`

=== Biblioth√®ques disponibles

Le syst√®me utilise plusieurs biblioth√®ques JavaScript :

* **GSAP** : Animations avanc√©es
** Core : `gsap.min.js`
** SplitText : `SplitText.min.js`
* **anime.js** : Animations l√©g√®res
* **Lottie** : Animations vectorielles
* **Web Speech API** : Synth√®se vocale (natif)

**Chemin des biblioth√®ques partag√©es** :
[source,text]
----
/desastres/shared/
‚îú‚îÄ‚îÄ gsap.min.js
‚îú‚îÄ‚îÄ SplitText.min.js
‚îî‚îÄ‚îÄ ...
----

=== D√©bogage

==== Forcer un d√©sastre avec trigger

Ajoutez le param√®tre `trigger` dans l'URL :

[source,text]
----
https://musiqueapproximative.net/post/123?debug_bleu
----

==== Logs console

Tous les d√©sastres loguent leur activation :

[source,javascript]
----
console.log('üé≠ D√©sastre "mangelettres" activ√©');
console.log('Options:', options);
----

==== Inspecter la configuration

La configuration est disponible dans `window.desastreOptions` :

[source,javascript]
----
console.log(window.desastreOptions);
----

== Liste des d√©sastres disponibles

[cols="1,2,1"]
|===
|Nom |Description |Technologie

|`amour`
|Effet visuel d'amour
|CSS/JS

|`bleu`
|Fond bleu
|CSS

|`danse`
|Animation de danse
|JS

|`fish`
|Poisson qui suit le curseur
|Lottie

|`kraftwerk`
|Effet Kraftwerk
|JS

|`light`
|Rayons lumineux
|Web Animations API

|`mamie`
|Images al√©atoires
|JS

|`mangelettres`
|Suppression de lettres
|GSAP SplitText

|`musique`
|Port√©e musicale avec lettres M
|anime.js + SVG

|`noir`
|Fond noir
|CSS

|`postillons`
|Effet de postillons
|JS

|`redirect`
|Redirection URL
|JS

|`robot`
|Effet robotique
|JS

|`sale`
|Effet sale/glitch
|JS

|`splitouine`
|Animation de texte
|GSAP SplitText

|`tts`
|Synth√®se vocale
|Web Speech API
|===

== Bonnes pratiques

=== Performance

* **Lazy loading** : Les scripts ne sont charg√©s que si le d√©sastre est d√©clench√©
* **Probabilit√©s** : Utilisez `probability` pour √©viter la lassitude
* **Cleanup** : Nettoyez les √©v√©nements et √©l√©ments DOM cr√©√©s

=== Accessibilit√©

* **Respect du prefers-reduced-motion** :
+
[source,javascript]
----
const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
if (prefersReducedMotion) {
  // D√©sactiver ou r√©duire les animations
  return;
}
----

* **Contr√¥les** : Permettre de d√©sactiver les effets
* **Audio** : Respecter les pr√©f√©rences de volume

=== Maintenance

* **Documentation** : Chaque d√©sastre doit avoir un README.adoc
* **Versioning** : Documenter les changements dans les recettes
* **Tests** : Tester avec diff√©rents contenus et navigateurs

== Troubleshooting

=== Le d√©sastre ne se d√©clenche pas

. **V√©rifier la r√®gle** : La condition est-elle remplie ?
+
[source,javascript]
----
console.log('Titre:', document.title);
----

. **V√©rifier la probabilit√©** : Essayer avec `probability: 1.0`

. **Utiliser le trigger** : Forcer avec `?debug_nom_desastre`

. **V√©rifier les scripts** : Ouvrir la console pour voir les erreurs

=== Erreur de chargement de script

* V√©rifier le chemin dans `scripts`
* S'assurer que le fichier existe
* V√©rifier les permissions

=== Conflit entre d√©sastres

* Certains d√©sastres peuvent interf√©rer (ex: deux d√©sastres modifiant le m√™me texte)
* Utiliser des s√©lecteurs CSS sp√©cifiques
* Tester les combinaisons

=== Performance d√©grad√©e

* R√©duire le nombre d'√©l√©ments anim√©s
* Utiliser `will-change` CSS pour optimiser
* D√©bouncer les √©v√©nements (scroll, mousemove)

== Ressources

* xref:architecture.adoc[Architecture du projet]
* xref:developpement/environnement.adoc[Environnement de d√©veloppement]
* https://gsap.com/docs/v3/[Documentation GSAP]
* https://animejs.com/documentation/[Documentation anime.js]
* https://developer.mozilla.org/en-US/docs/Web/API/Web_Speech_API[Web Speech API]
* https://airbnb.io/lottie/[Lottie Documentation]

---
