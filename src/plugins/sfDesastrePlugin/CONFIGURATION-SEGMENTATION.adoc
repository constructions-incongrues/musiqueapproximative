= Segmentation de la configuration des d√©sastres

== Probl√®me

Le fichier `desastres.yml` devient volumineux (284 lignes) et difficile √† maintenir :

* 19 r√®gles
* 15+ recettes
* M√©lange de r√®gles et recettes
* Difficile de retrouver une configuration sp√©cifique

== Solution propos√©e

=== Architecture modulaire avec imports

----
config/
‚îú‚îÄ‚îÄ desastres.yml                    # Point d'entr√©e principal
‚îî‚îÄ‚îÄ desastres/
    ‚îú‚îÄ‚îÄ regles/
    ‚îÇ   ‚îú‚îÄ‚îÄ colors.yml              # bleu, noir, light, rouge
    ‚îÇ   ‚îú‚îÄ‚îÄ themes.yml              # amour, mort, musique, phone
    ‚îÇ   ‚îú‚îÄ‚îÄ seasonal.yml            # quickos (No√´l), spooky
    ‚îÇ   ‚îú‚îÄ‚îÄ tts.yml                 # TTS rapper, TTS jinglist
    ‚îÇ   ‚îú‚îÄ‚îÄ effects.yml             # danse, splitouine
    ‚îÇ   ‚îî‚îÄ‚îÄ text.yml                # mangelettres (consonnard, voyelliste)
    ‚îî‚îÄ‚îÄ recettes/
        ‚îú‚îÄ‚îÄ colors.yml              # Recettes visuelles de couleurs
        ‚îú‚îÄ‚îÄ themes.yml              # Recettes th√©matiques
        ‚îú‚îÄ‚îÄ seasonal.yml            # Recettes saisonni√®res
        ‚îú‚îÄ‚îÄ tts.yml                 # Recettes TTS
        ‚îú‚îÄ‚îÄ effects.yml             # Recettes d'effets (danse, kraftwerk, sale)
        ‚îî‚îÄ‚îÄ text.yml                # Recettes de manipulation de texte
----

== Impl√©mentation

=== Approche 1 : Extension du sfDesastreManager (RECOMMAND√â)

Ajouter le support des imports YAML dans `sfDesastreManager.class.php`.

==== Syntaxe du fichier principal

*config/desastres.yml* :

[,yaml]
----
# Point d'entree principal - Musique Approximative
# Les regles et recettes sont importees depuis des fichiers externes

imports:
  regles:
    - desastres/regles/colors.yml
    - desastres/regles/themes.yml
    - desastres/regles/seasonal.yml
    - desastres/regles/tts.yml
    - desastres/regles/effects.yml
    - desastres/regles/text.yml
  recettes:
    - desastres/recettes/colors.yml
    - desastres/recettes/themes.yml
    - desastres/recettes/seasonal.yml
    - desastres/recettes/tts.yml
    - desastres/recettes/effects.yml
    - desastres/recettes/text.yml

# On peut aussi definir des regles/recettes directement ici
# Elles seront fusionnees avec les imports
regles: []
recettes: {}
----

==== Code d'impl√©mentation

*src/plugins/sfDesastrePlugin/lib/sfDesastreManager.class.php* :

[,php]
----
public function loadConfig($configPath)
{
  if (!file_exists($configPath)) {
    throw new sfException(sprintf('Le fichier de configuration "%s" n\'existe pas.', $configPath));
  }

  $config = sfYaml::load($configPath);

  // Traiter les imports si presents
  if (isset($config['imports'])) {
    $config = $this->processImports($config, dirname($configPath));
  }

  $this->config = $config;
  return $this;
}

/**
 * Traite les imports de fichiers YAML
 *
 * @param array $config Configuration avec imports
 * @param string $baseDir Repertoire de base pour les chemins relatifs
 * @return array Configuration fusionnee
 */
protected function processImports(array $config, $baseDir)
{
  $imports = isset($config['imports']) ? $config['imports'] : array();
  unset($config['imports']);

  // Initialiser les tableaux si non definis
  if (!isset($config['regles'])) {
    $config['regles'] = array();
  }
  if (!isset($config['recettes'])) {
    $config['recettes'] = array();
  }

  // Importer les regles
  if (isset($imports['regles']) && is_array($imports['regles'])) {
    foreach ($imports['regles'] as $importPath) {
      $fullPath = $baseDir . '/' . $importPath;
      if (file_exists($fullPath)) {
        $imported = sfYaml::load($fullPath);
        if (isset($imported['regles']) && is_array($imported['regles'])) {
          $config['regles'] = array_merge($config['regles'], $imported['regles']);
        }
      } else {
        // Log warning mais ne pas echouer
        error_log(sprintf('[sfDesastreManager] WARNING: Import file not found: %s', $fullPath));
      }
    }
  }

  // Importer les recettes
  if (isset($imports['recettes']) && is_array($imports['recettes'])) {
    foreach ($imports['recettes'] as $importPath) {
      $fullPath = $baseDir . '/' . $importPath;
      if (file_exists($fullPath)) {
        $imported = sfYaml::load($fullPath);
        if (isset($imported['recettes']) && is_array($imported['recettes'])) {
          // Fusionner les recettes (les cles sont les noms)
          $config['recettes'] = array_merge($config['recettes'], $imported['recettes']);
        }
      } else {
        error_log(sprintf('[sfDesastreManager] WARNING: Import file not found: %s', $fullPath));
      }
    }
  }

  return $config;
}
----

=== Approche 2 : Script de build (ALTERNATIF)

Si vous ne voulez pas modifier le plugin, cr√©ez un script qui fusionne les fichiers.

*bin/build-desastres-config.php* :

[,php]
----
#!/usr/bin/env php
<?php

require_once dirname(__FILE__) . '/../config/ProjectConfiguration.class.php';

$baseDir = dirname(__FILE__) . '/../src/apps/frontend/config';
$sourceDir = $baseDir . '/desastres';
$outputFile = $baseDir . '/desastres.generated.yml';

// Charger tous les fichiers de regles
$regles = array();
$reglesFiles = glob($sourceDir . '/regles/*.yml');
foreach ($reglesFiles as $file) {
  $config = sfYaml::load($file);
  if (isset($config['regles']) && is_array($config['regles'])) {
    $regles = array_merge($regles, $config['regles']);
  }
}

// Charger tous les fichiers de recettes
$recettes = array();
$recettesFiles = glob($sourceDir . '/recettes/*.yml');
foreach ($recettesFiles as $file) {
  $config = sfYaml::load($file);
  if (isset($config['recettes']) && is_array($config['recettes'])) {
    $recettes = array_merge($recettes, $config['recettes']);
  }
}

// Generer le fichier final
$output = array(
  'regles' => $regles,
  'recettes' => $recettes
);

file_put_contents($outputFile, sfYaml::dump($output, 10));
echo "Configuration generated: $outputFile\n";
----

Puis dans votre code, chargez `desastres.generated.yml` au lieu de `desastres.yml`.

=== Approche 3 : Glob pattern (SIMPLE & RAPIDE)

Modification minimale du manager pour charger automatiquement tous les fichiers d'un dossier.

*src/plugins/sfDesastrePlugin/lib/sfDesastreManager.class.php* :

[,php]
----
/**
 * Charge la configuration depuis un repertoire contenant plusieurs fichiers YAML
 *
 * @param string $configDir Chemin vers le repertoire
 * @return sfDesastreManager Instance courante pour chainage
 */
public function loadConfigDir($configDir)
{
  if (!is_dir($configDir)) {
    throw new sfException(sprintf('Le repertoire "%s" n\'existe pas.', $configDir));
  }

  $config = array('regles' => array(), 'recettes' => array());

  // Charger les regles
  $reglesDir = $configDir . '/regles';
  if (is_dir($reglesDir)) {
    foreach (glob($reglesDir . '/*.yml') as $file) {
      $imported = sfYaml::load($file);
      if (isset($imported['regles']) && is_array($imported['regles'])) {
        $config['regles'] = array_merge($config['regles'], $imported['regles']);
      }
    }
  }

  // Charger les recettes
  $recettesDir = $configDir . '/recettes';
  if (is_dir($recettesDir)) {
    foreach (glob($recettesDir . '/*.yml') as $file) {
      $imported = sfYaml::load($file);
      if (isset($imported['recettes']) && is_array($imported['recettes'])) {
        $config['recettes'] = array_merge($config['recettes'], $imported['recettes']);
      }
    }
  }

  $this->config = $config;
  return $this;
}
----

*Utilisation* :

[,php]
----
// Au lieu de :
$manager->loadConfig('/path/to/desastres.yml');

// Utiliser :
$manager->loadConfigDir('/path/to/desastres');
----

== Structure des fichiers segment√©s

=== Exemple : desastres/regles/colors.yml

[,yaml]
----
# Regles pour les desastres de couleurs
regles:
  # Desastre "bleu"
  - query: "query.title ~ /.*bleu.*/i || query.artist ~ /.*bleu.*/i"
    recettes: [bleu]
    probability: 0.7

  # Desastre "noir"
  - query: "query.title ~ /.*(noir|black).*/i"
    recettes: [noir]
    probability: 0.7
    scripts:
      - https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.2/anime.min.js

  # Desastre "light"
  - query: "query.title ~ /.*(light|lumiere).*/i"
    recettes: [light]
    probability: 0.7
    scripts:
      - https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.2/anime.min.js
----

=== Exemple : desastres/recettes/tts.yml

[,yaml]
----
# Recettes TTS (Text-to-Speech)
recettes:
  tts_rapper:
    enabled: true
    desastre: tts
    options:
      selector: div.descriptif p

  tts_jinglist:
    enabled: true
    desastre: tts
    options:
      url: https://n8n.musiques-incongrues.net/webhook/tts-jingles
      texts:
        - Vous √™tes sur Musique Approximative
        - Il fait beau n'est-ce pas ?
      pitch: [0.5, 1.5]
      rate: [0.5, 1]
      volume: 0.7
      lang: fr-fr
      voices: [Mauvaises nouvelles, Superstar, Violoncelles]
----

== Avantages

‚úÖ *Organisation claire* - Chaque cat√©gorie dans son fichier
‚úÖ *Maintenance facile* - Modifications cibl√©es
‚úÖ *Collaboration* - Moins de conflits Git
‚úÖ *R√©utilisabilit√©* - Import de fichiers dans diff√©rents environnements
‚úÖ *Testabilit√©* - Test de cat√©gories individuellement
‚úÖ *Documentation* - Chaque fichier peut avoir ses propres commentaires

== Migration progressive

=== √âtape 1 : Cr√©er la structure

[,bash]
----
cd src/apps/frontend/config
mkdir -p desastres/regles desastres/recettes
----

=== √âtape 2 : Extraire les r√®gles

Cr√©er `desastres/regles/colors.yml`, `tts.yml`, etc. avec les r√®gles correspondantes.

=== √âtape 3 : Extraire les recettes

Cr√©er `desastres/recettes/colors.yml`, `tts.yml`, etc. avec les recettes correspondantes.

=== √âtape 4 : Modifier le fichier principal

Remplacer le contenu de `desastres.yml` par la version avec imports.

=== √âtape 5 : Impl√©menter le loader

Choisir une approche (1, 2 ou 3) et l'impl√©menter.

=== √âtape 6 : Tester

[,bash]
----
# V√©rifier que les d√©sastres fonctionnent toujours
# Comparer l'ancienne et la nouvelle configuration
----

== R√©trocompatibilit√©

Pour garder la compatibilit√©, le manager doit :

. D√©tecter automatiquement le format (fichier unique vs imports)
. Si pas d'imports, charger normalement
. Si imports pr√©sents, fusionner les fichiers

[,php]
----
public function loadConfig($configPath)
{
  if (!file_exists($configPath)) {
    throw new sfException(sprintf('Le fichier de configuration "%s" n\'existe pas.', $configPath));
  }

  $config = sfYaml::load($configPath);

  // Si imports presents, traiter
  if (isset($config['imports'])) {
    $config = $this->processImports($config, dirname($configPath));
  }

  // Sinon, utiliser tel quel (r√©trocompatible)

  $this->config = $config;
  return $this;
}
----

== Recommandation finale

üéØ *Approche recommand√©e : Approche 1 (Imports dans le manager)*

*Pourquoi ?*

* Flexible : On peut m√©langer imports et d√©finitions directes
* Pas de rebuild n√©cessaire
* R√©trocompatible
* Maintenable √† long terme

*Plan d'action :*

. Impl√©menter `processImports()` dans sfDesastreManager
. Cr√©er la structure de dossiers
. Migrer progressivement les r√®gles et recettes
. Tester

'''

*Prochaines √©tapes* : Voulez-vous que j'impl√©mente l'approche 1 ?
