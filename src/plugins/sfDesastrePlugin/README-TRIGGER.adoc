= Param√®tre `trigger` pour les r√®gles de d√©sastres

== Description

Le param√®tre `trigger` permet de *forcer le d√©clenchement d'une r√®gle de d√©sastre* via un param√®tre d'URL, *ind√©pendamment de la condition `query` et de la `probability`*.

== Utilisation

=== Configuration dans desastres.yml

[,yaml]
----
regles:
  - query: "query.title ~ /(.*)/"
    recettes: [tts_jinglist]
    probability: 1.0
    trigger: jinglist  # ‚Üê Nouveau param√®tre
----

=== D√©clenchement

Lorsqu'un utilisateur acc√®de √† une URL contenant le param√®tre `jinglist` :

----
https://musiqueapproximative.net/post/12345?jinglist
https://musiqueapproximative.net/post/12345?jinglist=1
https://musiqueapproximative.net/post/12345?jinglist=true
----

‚Üí La r√®gle sera *d√©clench√©e syst√©matiquement*, peu importe :

* ‚úÖ La condition `query` (ignor√©e)
* ‚úÖ La `probability` (ignor√©e)

=== Sans le param√®tre trigger

Sans le param√®tre dans l'URL :

----
https://musiqueapproximative.net/post/12345
----

‚Üí La r√®gle fonctionne *normalement* :

* ‚úÖ √âvaluation de la condition `query`
* ‚úÖ Respect de la `probability`

== Comportement

|===
| Param√®tre URL | Condition `query` | Probability | R√©sultat

| ‚ùå Absent
| ‚úÖ Match
| 70%
| 70% de chance de d√©clencher

| ‚ùå Absent
| ‚ùå No match
| 70%
| Pas de d√©clenchement

| ‚úÖ Pr√©sent
| ‚ùå No match
| 70%
| *D√©clenchement garanti*

| ‚úÖ Pr√©sent
| ‚úÖ Match
| 70%
| *D√©clenchement garanti*
|===

== Exemples d'usage

=== 1. TTS Jingles √† la demande

[,yaml]
----
regles:
  - query: "query.title ~ /(.*)/"
    recettes: [tts_jinglist]
    probability: 0.1  # Seulement 10% du temps normalement
    trigger: jinglist
----

*Usage* :

* URL normale : 10% de chance d'avoir un jingle
* URL avec `?jinglist` : 100% de chance d'avoir un jingle

=== 2. Mode debug pour les d√©sastres

[,yaml]
----
regles:
  - query: "query.title ~ /.*bleu.*/i"
    recettes: [bleu]
    probability: 0.7
    trigger: debug_bleu
----

*Usage* :

* Test en d√©veloppement : `?debug_bleu` force le d√©sastre
* Production : Fonctionne avec les r√®gles normales

=== 3. Easter eggs activables

[,yaml]
----
regles:
  - query: "query.title == 'Secret Song'"
    recettes: [easter_egg]
    probability: 1.0
    trigger: reveal
----

*Usage* :

* Normalement : Seulement sur "Secret Song"
* Avec `?reveal` : Sur toutes les pages

=== 4. Tests A/B

[,yaml]
----
regles:
  - query: "query.title ~ /(.*)/"
    recettes: [new_feature]
    probability: 0.5  # 50% des utilisateurs
    trigger: force_feature
----

*Usage* :

* QA : `?force_feature` pour tester la nouvelle fonctionnalit√©
* Utilisateurs : 50% re√ßoivent la fonctionnalit√© al√©atoirement

== Impl√©mentation technique

=== Flux de traitement

[,php]
----
// Dans sfDesastreManager::findRecettes()

foreach ($regles as $regle) {
  // 1. V√©rifier si un trigger est d√©fini
  if (isset($regle['trigger'])) {
    $triggerParam = $regle['trigger'];

    // 2. V√©rifier si le param√®tre existe dans l'URL
    if (isset($query[$triggerParam])) {
      // ‚Üí D√âCLENCHEMENT GARANTI
      applyRecettes($regle['recettes']);
      continue;
    }
  }

  // 3. Sinon, √©valuation normale
  if (evaluate($regle['query'])) {
    if (random() <= $regle['probability']) {
      applyRecettes($regle['recettes']);
    }
  }
}
----

=== Code source

Voir : link:../lib/sfDesastreManager.class.php#L82-L127[sfDesastreManager.class.php:82-127]

== Valeur du param√®tre

Le syst√®me v√©rifie *uniquement la pr√©sence* du param√®tre dans l'URL.

La *valeur* du param√®tre n'a *pas d'importance* :

[,php]
----
?jinglist       // ‚úÖ D√©clenche
?jinglist=1     // ‚úÖ D√©clenche
?jinglist=true  // ‚úÖ D√©clenche
?jinglist=false // ‚úÖ D√©clenche (pr√©sent = d√©clench√©)
?jinglist=0     // ‚úÖ D√©clenche (pr√©sent = d√©clench√©)
----

Pour v√©rifier la valeur, utilisez la condition `query` :

[,yaml]
----
- query: "query.jinglist == 'special'"
  trigger: jinglist
  recettes: [tts_special]
----

== Cas d'usage avanc√©s

=== Combinaison avec plusieurs recettes

[,yaml]
----
regles:
  # D√©sastre principal
  - query: "query.title ~ /.*music.*/i"
    recettes: [music_basic, music_animations]
    probability: 0.8
    trigger: force_music
----

Avec `?force_music`, *toutes* les recettes sont appliqu√©es : `music_basic` + `music_animations`

=== Plusieurs triggers diff√©rents

[,yaml]
----
regles:
  - query: "query.title ~ /.*bleu.*/i"
    recettes: [bleu]
    trigger: bleu

  - query: "query.title ~ /.*rouge.*/i"
    recettes: [rouge]
    trigger: rouge
----

*Usage* :

* `?bleu` ‚Üí Force le d√©sastre bleu
* `?rouge` ‚Üí Force le d√©sastre rouge
* `?bleu&rouge` ‚Üí Force les deux d√©sastres

=== Trigger avec condition fallback

[,yaml]
----
regles:
  # Version premium avec trigger
  - query: "query.premium == 'true'"
    recettes: [premium_tts]
    trigger: premium

  # Version normale
  - query: "query.title ~ /(.*)/"
    recettes: [basic_tts]
    probability: 0.1
----

== Compatibilit√©

‚úÖ Compatible avec toutes les versions existantes du plugin
‚úÖ R√©trocompatible : Les r√®gles sans `trigger` fonctionnent normalement
‚úÖ Compatible avec tous les types de recettes

== S√©curit√©

‚ö†Ô∏è *Attention* : Les triggers sont publics et peuvent √™tre d√©couverts par les utilisateurs.

Si vous souhaitez prot√©ger un trigger :

[,yaml]
----
regles:
  - query: "query.admin_token == 'secret_value_here'"
    recettes: [admin_panel]
    trigger: admin_mode
    probability: 1.0
----

Ainsi, m√™me avec `?admin_mode`, la condition `query.admin_token` doit √™tre valid√©e.

== D√©bogage

=== Logs PHP

Le manager n'ajoute pas de logs par d√©faut. Pour d√©buguer :

[,php]
----
// Dans sfDesastreManager.class.php, ligne 96
if ($triggerMatch) {
  error_log("Trigger '{$triggerParam}' matched for rule: " . print_r($regle, true));
  $shouldApply = true;
}
----

=== JavaScript Console

C√¥t√© client, v√©rifiez les d√©sastres charg√©s :

[,javascript]
----
// Dans la console du navigateur
console.log(window.DesastreOptions);
----

=== Test curl

[,bash]
----
# Sans trigger
curl "https://ma.net/post/12345" | grep -i "desastre"

# Avec trigger
curl "https://ma.net/post/12345?jinglist" | grep -i "desastre"
----

== Changelog

=== Version 1.1.0 (2025-11-10)

* ‚ú® Ajout du param√®tre `trigger` pour forcer le d√©clenchement des r√®gles
* ‚ú® Bypass de la condition `query` et de la `probability` quand le trigger est pr√©sent
* üìù Documentation compl√®te du syst√®me de triggers

'''

*Auteur* : Musique Approximative
*Licence* : Voir LICENSE du plugin
